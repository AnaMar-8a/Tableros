import React, { useState, useEffect, useMemo } from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
  ComposedChart, Area, PieChart, Pie, Cell 
} from 'recharts';
import { 
  Info, TrendingDown, TrendingUp, Filter, Calendar, 
  Download, Activity, Target, AlertCircle, LayoutGrid, RefreshCw, MoreHorizontal, ArrowRight,
  Moon, Sun, Check, X, ArrowLeft
} from 'lucide-react';

// --- DEFINICIONES TÉCNICAS ---

const METRIC_DEFINITIONS = {
  wmape: {
    title: "WMAPE (Error Ponderado)",
    definition: "Mide el error total del plan de demanda ponderado por el volumen real, reflejando el impacto económico de las desviaciones.",
    formula: [
      "1) Se calcula el error absoluto entre plan y real.",
      "2) Se suman todos los errores.",
      "3) Se divide por la demanda real total.",
      "4) Se expresa como porcentaje."
    ],
    usage: "Lectura ejecutiva del impacto del error en el negocio.",
    aggregation: "Negocio, Categoría, Línea, Canal, Región"
  },
  bias: {
    title: "BIAS (Sesgo)",
    definition: "Mide la tendencia sistemática del plan a sobreestimar o subestimar la demanda.",
    formula: [
      "1) Se suman las diferencias entre plan y real (con signo).",
      "2) Se divide por la demanda real total.",
      "3) Se expresa como porcentaje."
    ],
    usage: "Identificar sesgos estructurales del proceso.",
    aggregation: "Negocio, Categoría, Línea, Canal, Región"
  },
  health: {
    title: "Índice de Salud del Portafolio",
    definition: "Mide el porcentaje de materiales cuyo MAPE individual se encuentra en o por debajo de la meta definida.",
    formula: [
      "1) Se define una meta de MAPE (ej. 20%).",
      "2) Se cuentan los materiales con MAPE ≤ meta.",
      "3) Se divide entre el total de materiales evaluados."
    ],
    usage: "Evaluar la salud global del portafolio sin ponderación por volumen.",
    aggregation: "Negocio, Categoría, Línea, Marca"
  },
  mapeRef: {
    title: "MAPE (Referencia)",
    definition: "Mide el error porcentual del plan de demanda a nivel individual, tratando cada material de forma equitativa.",
    formula: [
      "1) Para cada material, se calcula el error porcentual frente a la demanda real.",
      "2) No se pondera por volumen."
    ],
    usage: "Diagnóstico del desempeño por referencia (SKU).",
    aggregation: "Producto / SKU, Sector, Categoría"
  }
};

// --- TEMAS ---

const themes = {
  amop: {
    id: 'amop',
    label: 'AMOP',
    font: 'font-sans',
    isGeometric: false,
    colors: {
      light: {
        bg: 'bg-indigo-50/30',
        text: 'text-slate-900',
        heading: 'text-indigo-900',
        cardBg: '#ffffff',
        border: 'border-indigo-100',
        accent: '#6366f1',
        secondary: '#d946ef',
        gradient: 'from-indigo-600 to-fuchsia-600',
        badgePos: 'bg-indigo-50 text-indigo-700 border-indigo-200',
        badgeNeg: 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200',
      },
      dark: {
        bg: 'bg-slate-950',
        text: 'text-indigo-50',
        heading: 'text-white',
        cardBg: '#0f172a',
        border: 'border-slate-800',
        accent: '#818cf8',
        secondary: '#e879f9',
        gradient: 'from-indigo-500 to-fuchsia-500',
        badgePos: 'bg-indigo-900/30 text-indigo-300 border-indigo-800',
        badgeNeg: 'bg-fuchsia-900/30 text-fuchsia-300 border-fuchsia-800',
      }
    }
  },
  nutresa: {
    id: 'nutresa',
    label: 'Nutresa',
    font: 'font-montserrat', 
    isGeometric: true, 
    colors: {
      light: {
        styleBg: '#F8F9FA',
        styleText: '#333333',
        styleHeading: '#2D5A27',
        styleAccent: '#76B82A',
        styleCardBg: '#FFFFFF',
        styleBorder: '#76B82A',
        accent: '#2D5A27', 
        secondary: '#76B82A',
        gradient: 'from-[#2D5A27] to-[#76B82A]',
        badgePos: 'bg-[#E9F5E6] text-[#2D5A27] border-[#76B82A]',
        badgeNeg: 'bg-red-50 text-red-800 border-red-200',
      },
      dark: {
        styleBg: '#121212',
        styleText: '#E0E0E0',
        styleHeading: '#8BD13F',
        styleCardBg: '#1E1E1E', 
        styleBorder: '#4A773C',
        styleAccent: '#2D5A27',
        accent: '#8BD13F',
        secondary: '#4A773C',
        gradient: 'from-[#2D5A27] to-[#8BD13F]',
        badgePos: 'bg-[#252B24] text-[#8BD13F] border-[#4A773C]',
        badgeNeg: 'bg-red-900/20 text-red-300 border-red-800',
      }
    }
  },
  summan: {
    id: 'summan',
    label: 'Summan',
    font: 'font-montserrat',
    isGeometric: true,
    colors: {
      light: {
        styleBg: '#FDFDFD',
        styleText: '#333333',
        styleHeading: '#1A1A1B',
        styleCardBg: '#FFFFFF',
        styleBorder: '#E69D4F',
        styleAccent: '#A3C657',
        accent: '#A3C657',
        secondary: '#F9D423',
        gradient: 'from-[#A3C657] to-[#F9D423]',
        badgePos: 'bg-[#A3C657] text-[#1A1A1B] border-[#8CB045] font-semibold',
        badgeNeg: 'bg-[#F2B134] text-[#1A1A1B] border-[#D99E20] font-semibold',
      },
      dark: {
        styleBg: '#1A1A1B',
        styleText: '#E0E0E0',
        styleHeading: '#F9D423',
        styleCardBg: '#252526',
        styleBorder: '#A3C657',
        accent: '#A3C657',
        secondary: '#F9D423',
        gradient: 'from-[#A3C657] to-[#F2B134]',
        badgePos: 'bg-[#A3C657]/20 text-[#A3C657] border-[#A3C657]',
        badgeNeg: 'bg-[#F2B134]/20 text-[#F2B134] border-[#F2B134]',
      }
    }
  },
  minimal: {
    id: 'minimal',
    label: 'Grises',
    font: 'font-sans',
    isGeometric: false,
    colors: {
      light: {
        bg: 'bg-gray-50',
        text: 'text-gray-600',
        heading: 'text-gray-900',
        cardBg: '#ffffff',
        border: 'border-gray-200',
        accent: '#4b5563',
        secondary: '#9ca3af',
        gradient: 'from-gray-700 to-gray-900',
        badgePos: 'bg-gray-100 text-gray-800 border-gray-200',
        badgeNeg: 'bg-gray-100 text-gray-600 border-gray-300',
      },
      dark: {
        bg: 'bg-black',
        text: 'text-gray-400',
        heading: 'text-white',
        cardBg: '#171717',
        border: 'border-neutral-800',
        accent: '#d4d4d4',
        secondary: '#525252',
        gradient: 'from-neutral-600 to-neutral-200',
        badgePos: 'bg-neutral-800 text-neutral-300 border-neutral-700',
        badgeNeg: 'bg-neutral-900 text-neutral-500 border-neutral-800',
      }
    }
  }
};

// --- DATA UTILS ---

const generateRandomTrend = (months) => {
  return months.map(month => {
    const wmape = Math.floor(Math.random() * (35 - 15 + 1)) + 15;
    const bias = Math.floor(Math.random() * (8 - (-8) + 1)) + (-8);
    const health = Math.min(95, Math.max(40, 100 - wmape - Math.abs(bias) + Math.floor(Math.random() * 10)));
    return { month, wmape, bias, health };
  });
};

const generateCategoryData = () => {
  const categories = ['Cárnicos', 'Helados', 'Café', 'Novaventa', 'Galletas', 'Chocolates', 'Pastas', 'TMLUC'];
  return categories.map(name => {
    const wmape = Math.floor(Math.random() * (38 - 12 + 1)) + 12; 
    const health = Math.min(99, Math.max(35, 100 - wmape - 2));
    // volumeImpact removed as unused in display
    return { name, wmape, health };
  }).sort((a, b) => b.wmape - a.wmape);
};

// --- COMPONENTS ---

const Card = ({ children, className = "", themeConfig }) => {
  const style = themeConfig.styleCardBg ? {
    backgroundColor: themeConfig.styleCardBg,
    borderColor: themeConfig.styleBorder,
    borderWidth: '1px',
    borderStyle: 'solid'
  } : {
    backgroundColor: themeConfig.cardBg 
  };
  const borderClass = !themeConfig.styleBorder ? themeConfig.border : '';
  
  return (
    <div 
      className={`rounded-xl transition-all duration-300 shadow-sm border ${borderClass} ${className}`}
      style={style}
    >
      {children}
    </div>
  );
};

const Badge = ({ children, type = 'neutral', themeConfig }) => {
  const badgeClass = type === 'positive' ? themeConfig.badgePos : themeConfig.badgeNeg;
  return (
    <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold border inline-flex items-center gap-1 ${badgeClass}`}>
      {children}
    </span>
  );
};

const DetailPopup = ({ isOpen, onClose, definitionData, themeConfig }) => {
  if (!isOpen) return null;
  const bgColor = themeConfig.styleCardBg || themeConfig.cardBg || '#ffffff';
  const textColor = themeConfig.styleText || '#1f2937';
  const borderColor = themeConfig.styleBorder || '#e5e7eb';

  return (
    <div className="absolute top-12 left-0 w-full z-[100] px-2 animate-in fade-in zoom-in-95 duration-200">
      <div 
        className="rounded-xl shadow-2xl p-4 text-xs relative border bg-white"
        style={{
          backgroundColor: bgColor, 
          color: textColor,
          borderColor: borderColor,
          boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0,0,0,0.05)'
        }}
      >
        <button 
          onClick={(e) => { e.stopPropagation(); onClose(); }}
          className="absolute top-2 right-2 opacity-50 hover:opacity-100 transition-opacity p-1 rounded-full hover:bg-black/5"
        >
          <X size={14} />
        </button>

        <h4 className="font-bold mb-2 text-sm pr-6 border-b pb-2" style={{ borderColor: themeConfig.styleBorder ? `${themeConfig.styleBorder}30` : '#e5e7eb' }}>
          {definitionData.title}
        </h4>
        
        <div className="space-y-2">
          <div>
            <span className="font-bold text-[10px] uppercase tracking-wider opacity-70 block mb-0.5">Definición</span>
            <p className="leading-snug opacity-90">{definitionData.definition}</p>
          </div>
          <div className="bg-black/5 p-2 rounded-lg border border-black/5">
            <span className="font-bold text-[10px] uppercase tracking-wider opacity-70 block mb-0.5">Fórmula</span>
            <ul className="list-disc list-inside space-y-0.5 opacity-90">
              {definitionData.formula.map((step, i) => <li key={i}>{step}</li>)}
            </ul>
          </div>
          <div>
            <span className="font-bold text-[10px] uppercase tracking-wider opacity-70 block mb-0.5">Uso</span>
            <p className="italic opacity-80">{definitionData.usage}</p>
          </div>
        </div>
      </div>
      <div className="fixed inset-0 z-[90]" onClick={(e) => { e.stopPropagation(); onClose(); }}></div>
    </div>
  );
};

const MetricCard = ({ title, value, trend, trendValue, icon: Icon, definitionKey, themeConfig, isGeometric, suffix = "" }) => {
  const [showPopup, setShowPopup] = useState(false);
  const definitionData = METRIC_DEFINITIONS[definitionKey];
  const gradientClass = `bg-gradient-to-br ${themeConfig.gradient}`;
  const titleStyle = themeConfig.styleText ? { color: themeConfig.styleText, opacity: 0.7 } : {};
  const valueStyle = themeConfig.styleHeading ? { color: themeConfig.styleHeading } : {};
  const geometricTitle = isGeometric ? 'uppercase tracking-widest' : '';

  return (
    <Card 
      className={`p-4 relative group transition-all duration-300 h-full flex flex-col justify-between ${showPopup ? 'z-50 ring-2 ring-offset-2 ring-indigo-500/20' : 'z-0 hover:-translate-y-1'}`} 
      themeConfig={themeConfig} 
    >
      <div className={`absolute top-0 right-0 w-24 h-24 ${gradientClass} opacity-[0.08] rounded-bl-full -mr-6 -mt-6 pointer-events-none`}></div>
      
      <div className="flex justify-between items-start mb-2 relative z-10">
        <div className={`p-2 rounded-xl ${gradientClass} text-white shadow-md`}>
          <Icon className="w-5 h-5" strokeWidth={2.5} />
        </div>
        <button 
          onClick={() => setShowPopup(!showPopup)}
          className={`relative p-1.5 rounded-full hover:bg-black/5 transition-colors focus:outline-none ${showPopup ? 'bg-black/10' : ''}`}
          style={{ color: themeConfig.styleText }}
        >
          <Info className="w-4 h-4 opacity-50 hover:opacity-100" />
        </button>
      </div>

      <DetailPopup isOpen={showPopup} onClose={() => setShowPopup(false)} definitionData={definitionData} themeConfig={themeConfig} />
      
      <div className="relative z-10">
        <h3 className={`text-xs font-bold mb-0.5 ${geometricTitle}`} style={titleStyle}>{title}</h3>
        <div className="flex items-baseline gap-1">
          <span className="text-3xl font-extrabold tracking-tight" style={valueStyle}>{value}</span>
          <span className="text-sm font-semibold opacity-60" style={valueStyle}>{suffix}</span>
        </div>
        <div className="mt-2 flex items-center gap-2">
          <Badge type={trend === 'positive' ? 'positive' : 'negative'} themeConfig={themeConfig}>
            {trend === 'positive' ? <TrendingDown className="w-3 h-3" /> : <TrendingUp className="w-3 h-3" />}
            {trendValue}
          </Badge>
          <span className="text-[10px] font-semibold opacity-50" style={themeConfig.styleText ? { color: themeConfig.styleText } : {}}>vs. mes ant.</span>
        </div>
      </div>
    </Card>
  );
};

// --- DASHBOARD PRINCIPAL ---

export default function DemandDashboard() {
  const [period, setPeriod] = useState('Mensual');
  const [dataVersion, setDataVersion] = useState(0);
  const [currentThemeId, setCurrentThemeId] = useState('summan'); 
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [activePage, setActivePage] = useState('dashboard'); 
  
  // UseMemo for Theme Config
  const themeObj = themes[currentThemeId];
  const themeConfig = isDarkMode ? themeObj.colors.dark : themeObj.colors.light;

  // UseMemo for Data Generation - Optimized Performance
  const { trendData, categoryData, kpiData } = useMemo(() => {
    const monthsList = period === 'Mensual' 
      ? ['Ago', 'Sep', 'Oct', 'Nov', 'Dic', 'Ene']
      : period === 'Trimestral' 
        ? ['Q1', 'Q2', 'Q3', 'Q4', 'Q1']
        : ['2022', '2023', '2024', '2025', 'YTD'];

    const tData = generateRandomTrend(monthsList);
    const cData = generateCategoryData();
    const current = tData[tData.length - 1];
    const previous = tData[tData.length - 2] || current;

    const kData = {
      wmape: { 
        value: current.wmape, 
        trend: current.wmape < previous.wmape ? 'positive' : 'negative',
        change: Math.abs(current.wmape - previous.wmape).toFixed(1) + '%'
      },
      bias: { 
        value: current.bias, 
        trend: Math.abs(current.bias) < Math.abs(previous.bias) ? 'positive' : 'negative',
        change: Math.abs(current.bias - previous.bias).toFixed(1) + '%'
      },
      health: { 
        value: current.health, 
        trend: current.health > previous.health ? 'positive' : 'negative',
        change: Math.abs(current.health - previous.health).toFixed(1) + '%'
      },
      mapeRef: { 
        value: (current.wmape * 1.5).toFixed(1),
        trend: 'negative',
        change: '1.2%'
      }
    };

    return { trendData: tData, categoryData: cData, kpiData: kData };
  }, [period, dataVersion]);

  const healthDistribution = useMemo(() => [
    { name: 'Saludable', value: kpiData.health.value, color: themeConfig.accent },
    { name: 'Riesgo', value: 100 - kpiData.health.value, color: isDarkMode ? '#334155' : '#e2e8f0' },
  ], [kpiData.health.value, themeConfig.accent, isDarkMode]);

  const containerStyle = themeConfig.styleBg ? { backgroundColor: themeConfig.styleBg, color: themeConfig.styleText } : {};
  const containerClass = !themeConfig.styleBg ? `${themeConfig.bg} ${themeConfig.text}` : '';
  const fontClass = themeObj.font;
  const headingStyle = themeConfig.styleHeading ? { color: themeConfig.styleHeading } : {};
  const headingClass = !themeConfig.styleHeading ? themeConfig.heading : '';

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-900 p-4">
      {/* FRAME CONTENEDOR 1280x720 */}
      <div 
        className={`relative overflow-hidden shadow-2xl transition-colors duration-300 selection:bg-lime-200 selection:text-lime-900 ${containerClass} ${fontClass}`} 
        style={{ 
          ...containerStyle, 
          width: '1280px', 
          height: '720px',
          borderRadius: '8px'
        }}
      >
        <style>
          {`
            @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
            .font-montserrat { font-family: 'Montserrat', sans-serif; }
            .animate-in { animation: fadeIn 0.3s ease-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
          `}
        </style>

        {/* HEADER COMPACTO */}
        <header className="absolute top-0 left-0 w-full h-16 border-b z-40 flex items-center justify-between px-6 backdrop-blur-md"
          style={{ 
            backgroundColor: themeConfig.styleBg ? `${themeConfig.styleBg}dd` : undefined, 
            borderColor: themeConfig.styleBorder || undefined 
          }}
        >
          <div className="flex items-center gap-6">
            <div className="flex items-center gap-3">
              <div className={`w-9 h-9 rounded-xl flex items-center justify-center shadow-lg text-white bg-gradient-to-tr ${themeConfig.gradient}`}>
                <LayoutGrid size={18} />
              </div>
              <div>
                <h1 className={`text-lg font-extrabold tracking-tight leading-none ${headingClass}`} style={headingStyle}>
                  Demand<span className={`bg-clip-text text-transparent bg-gradient-to-r ${themeConfig.gradient}`}>Analytics</span>
                </h1>
                <div className="flex items-center gap-2 text-[10px] font-bold mt-0.5 opacity-60 uppercase tracking-wider">
                  <span>GN Corporativo</span>
                  <span className="w-1 h-1 rounded-full bg-current opacity-40"></span>
                  <span>Enero 2026</span>
                </div>
              </div>
            </div>

            {/* Selector de Temas Compacto */}
            <div className="flex items-center gap-1.5 ml-4 pl-4 border-l border-gray-200/20 h-8">
               {Object.values(themes).map((t) => (
                <button
                  key={t.id}
                  onClick={() => setCurrentThemeId(t.id)}
                  title={t.label}
                  className={`w-6 h-6 rounded-full flex items-center justify-center transition-all ${currentThemeId === t.id ? 'ring-2 ring-offset-1 ring-offset-transparent scale-110' : 'opacity-60 hover:opacity-100'}`}
                  style={{ background: `linear-gradient(135deg, ${t.colors.light.accent}, ${t.colors.light.secondary})` }}
                >
                  {currentThemeId === t.id && <Check size={12} className="text-white" />}
                </button>
              ))}
            </div>
            
            <button 
              onClick={() => setIsDarkMode(!isDarkMode)} 
              className="ml-2 opacity-50 hover:opacity-100 transition-opacity"
            >
              {isDarkMode ? <Sun size={18} /> : <Moon size={18} />}
            </button>
          </div>

          <div className="flex items-center gap-3">
            <div className={`p-1 rounded-lg flex items-center gap-1 border`} 
              style={{ 
                backgroundColor: themeConfig.styleCardBg || undefined,
                borderColor: themeConfig.styleBorder ? `${themeConfig.styleBorder}30` : 'transparent'
              }}>
              {['Mensual', 'Trimestral', 'YTD'].map((p) => (
                <button 
                  key={p}
                  onClick={() => setPeriod(p)}
                  className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${period === p ? 'shadow-sm' : 'hover:opacity-60 opacity-40'}`}
                  style={period === p ? { color: themeConfig.styleHeading || themeConfig.accent, backgroundColor: themeConfig.styleBg || '#fff' } : {}}
                >
                  {p}
                </button>
              ))}
            </div>
            <button onClick={() => setDataVersion(v => v + 1)} className="p-2 opacity-50 hover:opacity-100"><RefreshCw size={18} /></button>
          </div>
        </header>

        {/* CONTENIDO PRINCIPAL */}
        <div className="absolute top-16 bottom-0 w-full p-6 overflow-hidden flex flex-col">
          
          {/* NAVEGACIÓN DE PÁGINAS */}
          <div className="flex gap-6 mb-4 border-b" style={{ borderColor: themeConfig.styleBorder ? `${themeConfig.styleBorder}20` : 'rgba(0,0,0,0.1)' }}>
            <button 
              onClick={() => setActivePage('dashboard')}
              className={`pb-3 text-sm font-bold uppercase tracking-wide transition-all border-b-2 ${activePage === 'dashboard' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
              style={{ 
                borderColor: activePage === 'dashboard' ? themeConfig.accent : 'transparent',
                color: activePage === 'dashboard' ? themeConfig.accent : 'inherit'
              }}
            >
              1. Tablero Estratégico
            </button>
            <button 
              onClick={() => setActivePage('details')}
              className={`pb-3 text-sm font-bold uppercase tracking-wide transition-all border-b-2 ${activePage === 'details' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
              style={{ 
                borderColor: activePage === 'details' ? themeConfig.accent : 'transparent',
                color: activePage === 'details' ? themeConfig.accent : 'inherit'
              }}
            >
              2. Detalle Táctico
            </button>
          </div>

          {/* VISTA 1: DASHBOARD */}
          {activePage === 'dashboard' && (
            <div className="flex-1 flex flex-col gap-6 animate-in">
              <div className="grid grid-cols-4 gap-4 h-[140px]">
                <MetricCard title="WMAPE" definitionKey="wmape" value={kpiData.wmape.value} suffix="%" trend={kpiData.wmape.trend} trendValue={kpiData.wmape.change} icon={Activity} themeConfig={themeConfig} isGeometric={themeObj.isGeometric} />
                <MetricCard title="BIAS (Sesgo)" definitionKey="bias" value={(kpiData.bias.value > 0 ? '+' : '') + kpiData.bias.value} suffix="%" trend={kpiData.bias.trend} trendValue={kpiData.bias.change} icon={Target} themeConfig={themeConfig} isGeometric={themeObj.isGeometric} />
                <MetricCard title="Salud Portafolio" definitionKey="health" value={kpiData.health.value} suffix="%" trend={kpiData.health.trend} trendValue={kpiData.health.change} icon={Activity} themeConfig={themeConfig} isGeometric={themeObj.isGeometric} />
                <MetricCard title="MAPE (Ref)" definitionKey="mapeRef" value={kpiData.mapeRef.value} suffix="%" trend={kpiData.mapeRef.trend} trendValue={kpiData.mapeRef.change} icon={AlertCircle} themeConfig={themeConfig} isGeometric={themeObj.isGeometric} />
              </div>

              <div className="flex-1 grid grid-cols-3 gap-4 min-h-0">
                <Card className="col-span-2 p-5 flex flex-col" themeConfig={themeConfig}>
                  <div className="flex justify-between items-center mb-2">
                    <h3 className={`text-sm font-bold ${themeObj.isGeometric ? 'uppercase tracking-widest' : ''}`} style={headingStyle}>Evolución</h3>
                    <div className="flex gap-3 text-[10px] font-bold">
                       <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full" style={{backgroundColor: themeConfig.accent}}></span> WMAPE</span>
                       <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full" style={{backgroundColor: themeConfig.secondary}}></span> BIAS</span>
                    </div>
                  </div>
                  <div className="flex-1 w-full min-h-0">
                    <ResponsiveContainer width="100%" height="100%">
                      <ComposedChart data={trendData} margin={{ top: 10, right: 0, left: -20, bottom: 0 }}>
                        <defs>
                          <linearGradient id="colorMain" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor={themeConfig.accent} stopOpacity={0.25}/>
                            <stop offset="95%" stopColor={themeConfig.accent} stopOpacity={0}/>
                          </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={isDarkMode ? '#334155' : '#cbd5e1'} strokeOpacity={0.4} />
                        <XAxis dataKey="month" axisLine={false} tickLine={false} tick={{fill: themeConfig.styleText, fontSize: 11, fontWeight: 600}} dy={10} />
                        <YAxis yAxisId="left" axisLine={false} tickLine={false} tick={{fill: themeConfig.styleText, fontSize: 11, fontWeight: 600}} />
                        <YAxis yAxisId="right" orientation="right" hide />
                        <Tooltip contentStyle={{ borderRadius: '8px', fontSize: '12px' }} />
                        <Area yAxisId="left" type="monotone" dataKey="wmape" stroke={themeConfig.accent} strokeWidth={3} fill="url(#colorMain)" />
                        <Bar yAxisId="right" dataKey="bias" barSize={12} fill={themeConfig.secondary} radius={[2, 2, 0, 0]} />
                      </ComposedChart>
                    </ResponsiveContainer>
                  </div>
                </Card>

                <Card className="p-5 flex flex-col relative" themeConfig={themeConfig}>
                  <h3 className={`text-sm font-bold mb-2 ${themeObj.isGeometric ? 'uppercase tracking-widest' : ''}`} style={headingStyle}>Salud</h3>
                  <div className="flex-1 relative flex items-center justify-center min-h-0">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie data={healthDistribution} cx="50%" cy="50%" innerRadius={60} outerRadius={75} paddingAngle={2} dataKey="value" stroke="none">
                          {healthDistribution.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                        </Pie>
                        <Tooltip />
                      </PieChart>
                    </ResponsiveContainer>
                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                      <span className="text-3xl font-extrabold" style={headingStyle}>{kpiData.health.value}%</span>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2 mt-2">
                    <div className="p-2 rounded border text-center" style={{ borderColor: themeConfig.styleBorder ? `${themeConfig.styleBorder}30` : undefined }}>
                      <p className="text-[10px] font-bold uppercase opacity-60">OK</p>
                      <p className="text-lg font-bold" style={{color: themeConfig.accent}}>{(kpiData.health.value * 15.2).toFixed(0)}</p>
                    </div>
                    <div className="p-2 rounded border text-center" style={{ borderColor: themeConfig.styleBorder ? `${themeConfig.styleBorder}30` : undefined }}>
                       <p className="text-[10px] font-bold uppercase opacity-60">Riesgo</p>
                       <p className="text-lg font-bold opacity-60">{((100 - kpiData.health.value) * 15.2).toFixed(0)}</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => setActivePage('details')}
                    className="mt-4 w-full py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition-colors hover:bg-black/5"
                    style={{ color: themeConfig.accent }}
                  >
                    Ver reporte detallado <ArrowRight size={12} />
                  </button>
                </Card>
              </div>
            </div>
          )}

          {/* VISTA 2: DETALLES */}
          {activePage === 'details' && (
            <div className="flex-1 flex flex-col animate-in h-full">
               <Card className="flex-1 overflow-hidden flex flex-col" themeConfig={themeConfig}>
                  <div className="p-5 border-b flex justify-between items-center" style={{ borderColor: themeConfig.styleBorder ? `${themeConfig.styleBorder}40` : undefined }}>
                     <div>
                        <h3 className={`text-lg font-bold ${themeObj.isGeometric ? 'uppercase tracking-widest' : ''}`} style={headingStyle}>
                          Detalle por Negocio
                        </h3>
                        <p className="text-xs font-medium mt-1 opacity-60">Análisis de Pareto: Categorías ordenadas por desviación</p>
                     </div>
                     <button 
                        onClick={() => setActivePage('dashboard')}
                        className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-colors hover:bg-black/5"
                        style={{ color: themeConfig.styleText }}
                     >
                       <ArrowLeft size={16} /> Volver al Tablero
                     </button>
                  </div>
                  
                  <div className="flex-1 overflow-auto p-2">
                    <table className="w-full text-left text-sm">
                      <thead className="text-xs uppercase font-bold tracking-wider opacity-60 sticky top-0 backdrop-blur z-10" 
                             style={{ 
                               backgroundColor: themeConfig.styleCardBg ? `${themeConfig.styleCardBg}E6` : `${themeConfig.cardBg}E6`, // 90% opacity hex
                               color: themeConfig.styleText 
                             }}>
                        <tr>
                          <th className="px-6 py-4 font-bold">Categoría</th>
                          <th className="px-6 py-4 font-bold text-center">Precisión (WMAPE)</th>
                          <th className="px-6 py-4 font-bold pl-10">Índice Salud</th>
                          <th className="px-6 py-4 font-bold text-center">Diagnóstico</th>
                          <th className="px-6 py-4 font-bold text-right">Acciones</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y" style={{ divideColor: themeConfig.styleBorder ? `${themeConfig.styleBorder}20` : undefined }}>
                        {categoryData.map((cat, idx) => (
                          <tr key={idx} className="transition-colors hover:bg-black/5">
                            <td className="px-6 py-4">
                              <div className="flex items-center gap-4">
                                 <div className={`w-1 h-8 rounded-full ${idx < 3 ? 'opacity-100' : 'opacity-20'} -ml-4`} style={{backgroundColor: themeConfig.accent}}></div>
                                 <span className="font-bold">{cat.name}</span>
                              </div>
                            </td>
                            <td className="px-6 py-4 text-center">
                              <div className="inline-flex flex-col items-center">
                                <span className={`text-sm font-bold ${cat.wmape > 25 ? 'text-red-500' : ''}`} style={cat.wmape <= 25 ? { color: themeConfig.styleText } : {}}>
                                  {cat.wmape}%
                                </span>
                              </div>
                            </td>
                            <td className="px-6 py-4">
                              <div className="flex items-center gap-4 max-w-[200px]">
                                <span className="text-xs font-bold w-8 text-right opacity-60">{cat.health}%</span>
                                <div className="flex-1 h-2 rounded-full overflow-hidden bg-black/10">
                                  <div 
                                    className={`h-full rounded-full transition-all duration-1000 ${cat.health > 70 ? '' : 'bg-red-500'}`} 
                                    style={{ width: `${cat.health}%`, backgroundColor: cat.health > 70 ? themeConfig.accent : undefined }}
                                  ></div>
                                </div>
                              </div>
                            </td>
                            <td className="px-6 py-4 text-center">
                               {cat.wmape < 25 && cat.health > 70 ? (
                                 <Badge type="positive" themeConfig={themeConfig}><Check size={10} /> OK</Badge>
                               ) : (
                                 <Badge type="negative" themeConfig={themeConfig}><AlertCircle size={10} /> Revisar</Badge>
                               )}
                            </td>
                            <td className="px-6 py-4 text-right">
                              <button className="p-1.5 rounded hover:bg-black/10 opacity-50 hover:opacity-100"><MoreHorizontal size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
               </Card>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
