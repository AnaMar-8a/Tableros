<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Ejecutivo de Demanda - Mockup Power BI</title>
    
    <!-- 1. DEPENDENCIAS EXTERNAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- ESTILOS GLOBALES --- */
        body {
            background-color: #1e1e1e;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden; 
        }

        /* Wrapper de Escala */
        #scaler {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* --- FRAME POWER BI (1280x720 EXACTOS) --- */
        #pbi-container {
            width: 1280px;
            height: 720px;
            flex-shrink: 0; 
            background: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        /* --- UTILIDADES --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
    </style>
</head>
<body>

    <div id="scaler">
        <div id="root"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ComposedChart, Area, PieChart, Pie, Cell } = Recharts;

        // --- HOOK DE ESCALA ---
        function useWindowScale() {
            const [scale, setScale] = useState(1);
            useEffect(() => {
                const handleResize = () => {
                    const margin = 40;
                    const scale = Math.min((window.innerWidth - margin) / 1280, (window.innerHeight - margin) / 720, 1);
                    setScale(scale);
                };
                window.addEventListener('resize', handleResize);
                handleResize();
                return () => window.removeEventListener('resize', handleResize);
            }, []);
            return scale;
        }

        // --- ICONOS ---
        const Icon = ({ d, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const Icons = {
            Layout: () => <Icon d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" />,
            Activity: () => <Icon d="M22 12h-4l-3 9L9 3l-3 9H2" />,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Check: () => <Icon d="M20 6 9 17l-5-5" />,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            TrendUp: () => <Icon d="m23 6-9.5 9.5-5-5L1 18" />,
            TrendDown: () => <Icon d="m23 18-9.5-9.5-5 5L1 6" />,
            Filter: () => <Icon d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" />,
            Refresh: () => <Icon d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M21 3v5h-5M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16M3 21v-5h5" />,
            Moon: () => <Icon d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>,
            Close: () => <Icon d="M18 6 6 18M6 6l12 12" />,
            Calendar: () => <Icon d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm-7 14v-2" />,
            Briefcase: () => <Icon d="M20 7h-3a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        };

        // --- DEFINICIONES DE NEGOCIO ---
        const METRICS = {
            wmape: { label: "WMAPE", fullTitle: "Error Ponderado", desc: "Mide el error total del plan de demanda ponderado por el volumen real.", formula: ["Error Absoluto / Demanda Total"], usage: "Lectura ejecutiva." },
            bias: { label: "BIAS", fullTitle: "Sesgo", desc: "Tendencia a sobre/subestimar la demanda.", formula: ["(Real - Plan) / Real"], usage: "Identificar sesgos estructurales." },
            health: { label: "Salud Portafolio", fullTitle: "Índice de Salud", desc: "% SKUs con error ≤ meta.", formula: ["SKUs en meta / Total SKUs"], usage: "Calidad sin sesgo de volumen." },
            mape: { label: "MAPE Ref", fullTitle: "MAPE Promedio", desc: "Promedio simple de error.", formula: ["Promedio de errores %"], usage: "Diagnóstico operativo." }
        };

        const THEMES = {
            summan: { id: 'summan', name: 'Summan', light: { bg: '#FDFDFD', text: '#333333', head: '#1A1A1B', accent: '#A3C657', sec: '#F9D423', border: '#E69D4F', card: '#FFFFFF', chart1: '#A3C657', chart2: '#F9D423' }, dark: { bg: '#1A1A1B', text: '#E0E0E0', head: '#F9D423', accent: '#A3C657', sec: '#F2B134', border: '#A3C657', card: '#252526', chart1: '#A3C657', chart2: '#F2B134' } },
            nutresa: { id: 'nutresa', name: 'Nutresa', light: { bg: '#F8F9FA', text: '#333333', head: '#2D5A27', accent: '#2D5A27', sec: '#76B82A', border: '#76B82A', card: '#FFFFFF', chart1: '#2D5A27', chart2: '#76B82A' }, dark: { bg: '#121212', text: '#E0E0E0', head: '#8BD13F', accent: '#8BD13F', sec: '#2D5A27', border: '#4A773C', card: '#1E1E1E', chart1: '#8BD13F', chart2: '#4A773C' } },
            amop: { id: 'amop', name: 'AMOP', light: { bg: '#EEF2FF', text: '#1e293b', head: '#312e81', accent: '#6366f1', sec: '#d946ef', border: '#818cf8', card: '#FFFFFF', chart1: '#6366f1', chart2: '#d946ef' }, dark: { bg: '#020617', text: '#e2e8f0', head: '#ffffff', accent: '#818cf8', sec: '#e879f9', border: '#1e293b', card: '#0f172a', chart1: '#818cf8', chart2: '#e879f9' } },
            minimal: { id: 'minimal', name: 'Grises', light: { bg: '#f9fafb', text: '#4b5563', head: '#111827', accent: '#374151', sec: '#9ca3af', border: '#e5e7eb', card: '#FFFFFF', chart1: '#374151', chart2: '#9ca3af' }, dark: { bg: '#000000', text: '#9ca3af', head: '#ffffff', accent: '#d4d4d4', sec: '#525252', border: '#262626', card: '#171717', chart1: '#d4d4d4', chart2: '#525252' } }
        };

        // --- COMPONENTES ---
        const InfoPopup = ({ metricKey, theme, onClose }) => {
            const m = METRICS[metricKey];
            if (!m) return null;
            return (
                <div className="absolute top-14 left-4 z-50 w-72 rounded-xl shadow-2xl border p-4 text-sm fade-in" style={{ backgroundColor: theme.card, borderColor: theme.border, color: theme.text }}>
                    <div className="flex justify-between items-center mb-2 border-b pb-2" style={{borderColor: theme.border+'40'}}>
                        <h4 className="font-bold uppercase tracking-wide" style={{color: theme.head}}>{m.fullTitle}</h4>
                        <button onClick={onClose}><Icons.Close /></button>
                    </div>
                    <div className="space-y-3">
                        <div><span className="text-[10px] font-bold opacity-60 uppercase block">Definición</span><p className="leading-snug text-xs">{m.desc}</p></div>
                        <div className="p-2 rounded bg-black/5"><span className="text-[10px] font-bold opacity-60 uppercase block mb-1">Fórmula</span><ul className="list-disc pl-4 space-y-1 text-[10px]">{m.formula.map((step, i) => <li key={i}>{step}</li>)}</ul></div>
                        <div><span className="text-[10px] font-bold opacity-60 uppercase block">Uso Principal</span><p className="italic text-xs opacity-80">{m.usage}</p></div>
                    </div>
                </div>
            );
        };

        const KpiCard = ({ kpiKey, value, trend, label, icon: Icon, theme, activePopup, setActivePopup }) => {
            const isOpen = activePopup === kpiKey;
            return (
                <div className="relative p-5 rounded-2xl border shadow-sm flex flex-col justify-between hover:-translate-y-1 transition-transform duration-300 bg-opacity-50 backdrop-blur-sm" style={{ backgroundColor: theme.card, borderColor: theme.border }}>
                    <div className="flex justify-between items-start">
                        <div className="p-2 rounded-lg text-white shadow-md" style={{ background: `linear-gradient(135deg, ${theme.accent}, ${theme.sec})` }}><Icon /></div>
                        <button onClick={(e) => { e.stopPropagation(); setActivePopup(isOpen ? null : kpiKey); }} className="opacity-40 hover:opacity-100 transition-opacity" style={{color: theme.text}}><Icons.Info /></button>
                    </div>
                    {isOpen && <InfoPopup metricKey={kpiKey} theme={theme} onClose={() => setActivePopup(null)} />}
                    <div className="mt-4">
                        <h3 className="text-xs font-bold uppercase tracking-wider opacity-60 mb-1" style={{color: theme.text}}>{METRICS[kpiKey]?.label || label}</h3>
                        <div className="flex items-baseline gap-1">
                            <span className="text-3xl font-extrabold tracking-tight" style={{color: theme.head}}>{value}</span>
                            <div className={`flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded-full ml-2 border ${trend >= 0 ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200'}`}>
                                {trend >= 0 ? <Icons.TrendDown /> : <Icons.TrendUp />} {Math.abs(trend)}%
                            </div>
                        </div>
                        <p className="text-[10px] opacity-50 mt-1" style={{color: theme.text}}>vs. mes anterior</p>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function Dashboard() {
            const [themeId, setThemeId] = useState('summan');
            const [darkMode, setDarkMode] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [activePopup, setActivePopup] = useState(null);
            const [loaded, setLoaded] = useState(false);
            
            // --- ESTADO DE FILTROS ---
            const [periodo, setPeriodo] = useState('Mensual');
            const [negocio, setNegocio] = useState('Todos');
            const [refreshCount, setRefreshCount] = useState(0);

            const scale = useWindowScale(); 

            // Simulación de carga inicial
            useEffect(() => { setTimeout(() => setLoaded(true), 200); }, []);

            const theme = darkMode ? THEMES[themeId].dark : THEMES[themeId].light;

            // --- MOTOR DE SIMULACIÓN DE DATOS ---
            const dashboardData = useMemo(() => {
                // 1. Generar etiquetas de tiempo dinámicas
                let labels = [];
                if (periodo === 'Mensual') labels = ['Ago', 'Sep', 'Oct', 'Nov', 'Dic', 'Ene'];
                else if (periodo === 'Trimestral') labels = ['Q2-25', 'Q3-25', 'Q4-25', 'Q1-26'];
                else labels = ['2023', '2024', '2025', 'YTD'];

                // 2. Factor de aleatoriedad basado en el negocio y refresh
                const baseError = negocio === 'Todos' ? 20 : (negocio.length * 2) + 15; // Simular que cada negocio tiene su "personalidad" de error
                const randomSeed = refreshCount * 10; 

                // 3. Generar Tendencias
                const chartData = labels.map((label, i) => {
                    const noise = Math.sin(i + randomSeed) * 5; 
                    return {
                        name: label,
                        wmape: Math.max(10, Math.floor(baseError + noise + Math.random() * 5)),
                        bias: Math.floor((Math.random() * 10) - 5)
                    };
                });

                // 4. Calcular KPIs actuales (basados en el último dato)
                const current = chartData[chartData.length - 1];
                const prev = chartData[chartData.length - 2] || { wmape: 25, bias: 2 };
                
                const kpis = {
                    wmape: { value: current.wmape.toFixed(1) + '%', trend: -(current.wmape - prev.wmape).toFixed(1) },
                    bias: { value: (current.bias > 0 ? '+' : '') + current.bias.toFixed(1) + '%', trend: (current.bias - prev.bias).toFixed(1) },
                    health: { value: (100 - current.wmape - 5).toFixed(0) + '%', trend: 2.5 },
                    mape: { value: (current.wmape * 1.3).toFixed(1) + '%', trend: -1.2 }
                };

                // 5. Generar Tabla de Detalles
                let categories = ['Cárnicos', 'Helados', 'Café', 'Novaventa', 'Galletas', 'Chocolates', 'Pastas', 'TMLUC'];
                // Si se selecciona un negocio específico, lo ponemos primero o filtramos (simulacion)
                if (negocio !== 'Todos') {
                    // En simulación, si seleccionas "Cárnicos", mostramos subcategorías ficticias o solo ese
                    // Para mantener el layout lleno, simplemente reordenamos para que el seleccionado salga primero y variamos datos
                    categories = [negocio, ...categories.filter(c => c !== negocio)];
                }

                const catData = categories.map(c => {
                    const catError = Math.floor(baseError + (Math.random() * 15) - 7);
                    return {
                        name: c,
                        wmape: catError,
                        health: Math.min(99, 100 - catError + 5),
                        status: catError < 25 ? 'OK' : (catError < 35 ? 'Riesgo' : 'Crítico')
                    };
                }); // No ordenamos aquí para dejar que la "simulación" muestre cambios naturales, o podemos ordenar por error.
                
                // Ordenar por error descendente para Pareto
                catData.sort((a,b) => b.wmape - a.wmape);

                // 6. Datos Donut
                const healthVal = parseInt(kpis.health.value);
                const donutData = [{ name: 'Sano', value: healthVal }, { name: 'Riesgo', value: 100 - healthVal }];

                return { chartData, kpis, catData, donutData };

            }, [periodo, negocio, refreshCount]); // Recalcular cuando cambien estos estados

            if (!loaded) return <div className="text-white text-xl">Cargando Power BI Mockup...</div>;

            return (
                <div id="pbi-container" style={{ backgroundColor: theme.bg, color: theme.text, transform: `scale(${scale})` }}>
                    
                    {/* 1. HEADER */}
                    <header className="h-16 flex-none border-b flex items-center justify-between px-6 z-20 relative glass-panel" style={{ borderColor: theme.border + '40' }}>
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg" style={{ background: `linear-gradient(135deg, ${theme.accent}, ${theme.sec})` }}>
                                <Icons.Layout />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold leading-none tracking-tight uppercase" style={{ color: theme.head }}>Demand<span style={{ color: theme.accent }}>Analytics</span></h1>
                                <div className="flex items-center gap-2 text-[10px] font-semibold opacity-60 mt-1 uppercase tracking-widest">
                                    <span>GN Corporativo</span> <span className="w-1 h-1 rounded-full bg-current"></span> <span>Enero 2026</span>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-6">
                            
                            {/* FILTROS INTERACTIVOS */}
                            <div className="flex items-center gap-3">
                                {/* Selector Negocio */}
                                <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg border bg-opacity-50 transition-colors hover:bg-opacity-80" 
                                     style={{ borderColor: theme.border, backgroundColor: theme.card }}>
                                    <Icons.Filter size={14} className="opacity-50" />
                                    <select value={negocio} onChange={(e) => setNegocio(e.target.value)}
                                            className="bg-transparent text-xs font-bold uppercase tracking-wide focus:outline-none cursor-pointer pr-4"
                                            style={{ color: theme.text }}>
                                        <option value="Todos">Todos los Negocios</option>
                                        <option value="Cárnicos">Cárnicos</option>
                                        <option value="Lácteos">Lácteos</option>
                                        <option value="Galletas">Galletas</option>
                                        <option value="Café">Café</option>
                                    </select>
                                </div>

                                {/* Selector Periodo */}
                                <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg border bg-opacity-50 transition-colors hover:bg-opacity-80" 
                                     style={{ borderColor: theme.border, backgroundColor: theme.card }}>
                                    <Icons.Calendar size={14} className="opacity-50" />
                                    <select value={periodo} onChange={(e) => setPeriodo(e.target.value)}
                                            className="bg-transparent text-xs font-bold uppercase tracking-wide focus:outline-none cursor-pointer pr-4"
                                            style={{ color: theme.text }}>
                                        <option value="Mensual">Vista Mensual</option>
                                        <option value="Trimestral">Vista Trimestral</option>
                                        <option value="YTD">Acumulado YTD</option>
                                    </select>
                                </div>

                                {/* Botón Refresh */}
                                <button onClick={() => setRefreshCount(c => c + 1)} 
                                        className="p-2 rounded-lg border hover:bg-black/5 transition-all active:scale-95"
                                        style={{ borderColor: theme.border, color: theme.accent }}
                                        title="Actualizar Datos">
                                    <Icons.Refresh size={16} />
                                </button>
                            </div>

                            <div className="h-6 w-px bg-current opacity-10"></div>

                            {/* Temas */}
                            <div className="flex gap-2 p-1 rounded-full border" style={{ borderColor: theme.border + '30' }}>
                                {Object.values(THEMES).map(t => (
                                    <button key={t.id} onClick={() => setThemeId(t.id)} title={`Tema ${t.name}`}
                                            className={`w-5 h-5 rounded-full transition-transform ${themeId === t.id ? 'scale-110 ring-2 ring-offset-1' : 'opacity-50 hover:opacity-100'}`}
                                            style={{ background: t.light.accent, ringColor: theme.text }}>
                                    </button>
                                ))}
                            </div>
                            
                            <button onClick={() => setDarkMode(!darkMode)} className="opacity-60 hover:opacity-100 transition-opacity">
                                {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                            </button>
                        </div>
                    </header>

                    {/* 2. BODY */}
                    <div className="flex-1 p-6 overflow-hidden flex flex-col relative" onClick={() => setActivePopup(null)}>
                        
                        {/* Tabs */}
                        <div className="flex gap-8 border-b mb-6" style={{ borderColor: theme.border + '20' }}>
                            <button onClick={() => setActiveTab('dashboard')} 
                                    className={`pb-3 text-xs font-bold uppercase tracking-widest border-b-2 transition-all ${activeTab === 'dashboard' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                                    style={{ borderColor: activeTab === 'dashboard' ? theme.accent : 'transparent', color: activeTab === 'dashboard' ? theme.accent : 'inherit' }}>
                                1. Tablero Estratégico
                            </button>
                            <button onClick={() => setActiveTab('detail')} 
                                    className={`pb-3 text-xs font-bold uppercase tracking-widest border-b-2 transition-all ${activeTab === 'detail' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                                    style={{ borderColor: activeTab === 'detail' ? theme.accent : 'transparent', color: activeTab === 'detail' ? theme.accent : 'inherit' }}>
                                2. Detalle Táctico
                            </button>
                        </div>

                        {/* --- PÁGINA 1: DASHBOARD --- */}
                        {activeTab === 'dashboard' && (
                            <div className="flex-1 flex flex-col gap-6 fade-in min-h-0">
                                <div className="grid grid-cols-4 gap-6 flex-none h-36">
                                    <KpiCard kpiKey="wmape" value={dashboardData.kpis.wmape.value} trend={parseFloat(dashboardData.kpis.wmape.trend)} icon={Icons.Activity} theme={theme} activePopup={activePopup} setActivePopup={setActivePopup} />
                                    <KpiCard kpiKey="bias" value={dashboardData.kpis.bias.value} trend={parseFloat(dashboardData.kpis.bias.trend)} icon={Icons.Target} theme={theme} activePopup={activePopup} setActivePopup={setActivePopup} />
                                    <KpiCard kpiKey="health" value={dashboardData.kpis.health.value} trend={parseFloat(dashboardData.kpis.health.trend)} icon={Icons.Check} theme={theme} activePopup={activePopup} setActivePopup={setActivePopup} />
                                    <KpiCard kpiKey="mape" value={dashboardData.kpis.mape.value} trend={parseFloat(dashboardData.kpis.mape.trend)} icon={Icons.Alert} theme={theme} activePopup={activePopup} setActivePopup={setActivePopup} />
                                </div>

                                <div className="flex-1 grid grid-cols-3 gap-6 min-h-0">
                                    {/* Chart */}
                                    <div className="col-span-2 rounded-2xl border shadow-sm p-6 flex flex-col" style={{ backgroundColor: theme.card, borderColor: theme.border }}>
                                        <div className="flex justify-between mb-4">
                                            <h3 className="font-bold uppercase text-xs tracking-wider" style={{color: theme.head}}>Tendencia WMAPE vs BIAS ({periodo})</h3>
                                            <div className="flex gap-4 text-[10px] uppercase font-bold">
                                                <span className="flex items-center gap-2"><span className="w-2 h-2 rounded-full" style={{background: theme.chart1}}></span> WMAPE</span>
                                                <span className="flex items-center gap-2"><span className="w-2 h-2 rounded-full" style={{background: theme.chart2}}></span> BIAS</span>
                                            </div>
                                        </div>
                                        <div className="flex-1 min-h-0 w-full">
                                            <ResponsiveContainer>
                                                <ComposedChart data={dashboardData.chartData}>
                                                    <defs><linearGradient id="colorWmape" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={theme.chart1} stopOpacity={0.3}/><stop offset="95%" stopColor={theme.chart1} stopOpacity={0}/></linearGradient></defs>
                                                    <CartesianGrid vertical={false} strokeDasharray="3 3" stroke={theme.text} strokeOpacity={0.1} />
                                                    <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: theme.text, fontSize: 10}} dy={10} />
                                                    <YAxis axisLine={false} tickLine={false} tick={{fill: theme.text, fontSize: 10}} />
                                                    <Tooltip contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 10px 30px rgba(0,0,0,0.2)'}} />
                                                    <Area type="monotone" dataKey="wmape" stroke={theme.chart1} strokeWidth={3} fill="url(#colorWmape)" animationDuration={1000} />
                                                    <Bar dataKey="bias" barSize={20} fill={theme.chart2} radius={[4, 4, 0, 0]} animationDuration={1000} />
                                                </ComposedChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>

                                    {/* Donut */}
                                    <div className="rounded-2xl border shadow-sm p-6 flex flex-col items-center justify-center relative" style={{ backgroundColor: theme.card, borderColor: theme.border }}>
                                        <h3 className="absolute top-6 left-6 font-bold uppercase text-xs tracking-wider" style={{color: theme.head}}>Salud Portafolio</h3>
                                        <div className="w-48 h-48 relative">
                                            <ResponsiveContainer>
                                                <PieChart>
                                                    <Pie data={dashboardData.donutData} innerRadius={60} outerRadius={80} dataKey="value" stroke="none" animationDuration={1000}>
                                                        <Cell fill={theme.chart1} />
                                                        <Cell fill={theme.text + '20'} />
                                                    </Pie>
                                                </PieChart>
                                            </ResponsiveContainer>
                                            <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                                <span className="text-4xl font-extrabold" style={{color: theme.head}}>{dashboardData.kpis.health.value}</span>
                                                <span className="text-[10px] uppercase font-bold opacity-50">Sano</span>
                                            </div>
                                        </div>
                                        <div className="w-full mt-4 flex justify-between text-xs px-4">
                                            <div className="text-center"><div className="font-bold opacity-60">En Meta</div><div className="text-lg font-bold" style={{color: theme.accent}}>{(parseInt(dashboardData.kpis.health.value) * 15.2).toFixed(0)}</div></div>
                                            <div className="text-center"><div className="font-bold opacity-60">Fuera</div><div className="text-lg font-bold opacity-50">{((100 - parseInt(dashboardData.kpis.health.value)) * 15.2).toFixed(0)}</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- PÁGINA 2: DETALLE --- */}
                        {activeTab === 'detail' && (
                            <div className="flex-1 rounded-2xl border shadow-sm overflow-hidden flex flex-col fade-in" style={{ backgroundColor: theme.card, borderColor: theme.border }}>
                                <div className="p-6 border-b flex justify-between items-center" style={{borderColor: theme.border + '30'}}>
                                    <div>
                                        <h3 className="text-lg font-bold uppercase tracking-wider" style={{color: theme.head}}>Detalle: {negocio}</h3>
                                        <p className="text-xs opacity-60 mt-1">Análisis de Pareto: Ordenado por mayor impacto en WMAPE</p>
                                    </div>
                                    <button onClick={() => alert('Exportando CSV...')} className="flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide border transition-colors hover:bg-black/5" style={{borderColor: theme.border}}>
                                        <Icons.Refresh /> Exportar Datos
                                    </button>
                                </div>
                                <div className="flex-1 overflow-auto custom-scroll p-2">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="sticky top-0 z-10" style={{backgroundColor: theme.card}}>
                                            <tr className="text-[10px] uppercase font-bold opacity-50 border-b" style={{borderColor: theme.border + '30'}}>
                                                <th className="p-4 pl-6">Categoría</th>
                                                <th className="p-4 text-center">Precisión (WMAPE)</th>
                                                <th className="p-4 w-1/3">Índice de Salud</th>
                                                <th className="p-4 text-center">Estado</th>
                                                <th className="p-4 text-right pr-6">Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm">
                                            {dashboardData.catData.map((cat, i) => (
                                                <tr key={i} className="group hover:bg-black/5 transition-colors border-b last:border-0" style={{borderColor: theme.border + '10'}}>
                                                    <td className="p-4 pl-6 font-bold" style={{color: theme.head}}>
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-1 h-8 rounded-full" style={{background: i < 3 ? theme.accent : theme.text + '20'}}></div>
                                                            {cat.name}
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-center">
                                                        <span className={`px-2 py-1 rounded font-bold ${cat.wmape > 25 ? 'bg-red-100 text-red-700' : 'bg-transparent'}`} style={cat.wmape <= 25 ? {color: theme.text} : {}}>{cat.wmape}%</span>
                                                    </td>
                                                    <td className="p-4">
                                                        <div className="flex items-center gap-3">
                                                            <span className="font-bold w-8 text-right opacity-60">{cat.health}%</span>
                                                            <div className="flex-1 h-2 rounded-full bg-gray-200 overflow-hidden"><div className="h-full rounded-full" style={{width: `${cat.health}%`, background: cat.health > 70 ? theme.accent : '#ef4444'}}></div></div>
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-center">
                                                        {cat.status === 'OK' ? 
                                                            <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold border uppercase" style={{borderColor: theme.border, color: theme.accent}}><Icons.Check size={10} /> Estable</span> : 
                                                            <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold border border-red-200 bg-red-50 text-red-600 uppercase"><Icons.Alert size={10} /> {cat.status}</span>
                                                        }
                                                    </td>
                                                    <td className="p-4 text-right pr-6">
                                                        <button className="opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-black/10 rounded-full"><Icons.Layout size={16} /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
